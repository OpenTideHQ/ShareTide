name: NTLM credentials dumping via SMB connection
criticality: High
references:
  public:
    1: https://msrc.microsoft.com/blog/2023/03/microsoft-mitigates-outlook-elevation-of-privilege-vulnerability/
    2: https://www.mdsec.co.uk/2023/03/exploiting-cve-2023-23397-microsoft-outlook-elevation-of-privilege-vulnerability/
    3: https://community.fireeye.com/s/question/0D53x00009EiMFOCA3/outlook-0day-cve202323397-protection
    4: https://blog.didierstevens.com/2019/05/20/webdav-ntlm-responder/
    5: https://blog.didierstevens.com/2017/11/13/webdav-traffic-to-malicious-sites/

metadata:
  uuid: 02311e3e-b7b8-4369-9e1e-74c0a844ae0f
  schema: tvm::2.0
  tlp: clear
  version: 3
  created: 2023-03-17
  modified: 2025-02-24
  organisation:
    uuid: 56b0a0f0-b0bc-47d9-bb46-02f80ae2065a
    name: EC DIGIT CSOC

threat:
  actors:
    - name: att&ck::G0007 #[Mobile] APT28, Sofacy, FROZENLAKE, Fancy Bear, Forest Blizzard, Group 74, IRON TWILIGHT, Pawn Storm, SNAKEMACKEREL, STRONTIUM, Sednit, Sofacy, Swallowtail, TG-4127, Threat Group-4127, Tsar Team
      #sighting: |
        #Type Here
      #references:
        #-
    - name: misp::5b4ee3ea-eee3-4c8e-8323-85ae32658754 #APT28
    - name: misp::e405b7d0-3eed-4f9d-9b68-728e9793974c #TA577
      #sighting: |
        #Type Here
      #references:
        #- 
    #- name: att&ck::G1037 # [Enterprise] TA577 (not in the list)
    
  killchain: Exploitation
  att&ck:
    - T1187 #Forced Authentication
    - T1190 #Exploit Public-Facing Application
    - T1068 #Exploitation for Privilege Escalation
    - T1212 #Exploitation for Credential Access
  cve:
    - CVE-2023-23397
    - CVE-2024-21413 # Microsoft Outlook RCE vulnerability known as the MonikerLink bug, allows for remote code execution and the leakage of local NTLM information
  domains:
    - Enterprise
  terrain: |
     - vulnerable Outlook clients CVE-2023-23397  
     - spearphising with a link to a SMB network share  
     - SMB or Webdav protocols are allowed to connect to external network shares
     directly or via a proxy
  targets:
    - Desktop
    - Laptop
    - Workstations
    - End-user
    - Email Platform
    - Customer
  platforms:
    - Windows
    - Office 365
  severity: Moderate incident
  leverage:
    - Information Disclosure
    - Infrastructure Compromise
  impact:
    - Data Breach
    - Identity Theft
  viability: Likely 
  description: |
    ### Attack vector related to Outlook vulnerability CVE-2023-23397

    **key point: no user interaction**  

    An attacker sends an email message with an extended MAPI property with a 
    UNC path pointing to an SMB network share on a threat actor-controlled 
    server.  
    
    When a vulnerable Microsoft Outlook client (CVE-2023-23397) 
    receives in the inbox, it processes that email.  
    
    Without any user interaction, a connection to the remote SMB server is 
    established and the user's NTLM negotiation message are passed in the 
    hearders.  
    
    The attacker can capture this message tp replay for authentication 
    against other systems that support NTLM authentication.  
    
    The attacker may also try to crack the original password if not too 
    complex.  
    
    The outbound NTLM negotiation message is passed with SMB and WebDav 
    protocols (see Didier Steven's blog).

    ### Attack vector using a link a user will be enticed to click on

    **key point: the user needs to click on the link**  

    This attack is a subset of attackers objectives when using spear 
    phishing emails with a link in message body or in an attachment.

    #### Attack vector using Outlook vulnerability

    A vulnerability like CVE-2024-21413, also known as the MonikerLink bug, 
    allows remote code execution and the leakage of local NTLM information.  

    Moniker-based links exploit a logic flaw in how vulnerable versions
    of Outlook process certain file types, causing files to open in
    editing mode instead of the sandboxed `Protected View`.  

    If the malicious link points to SMB shares controlled by the attacker,
    Windows automatically attempts to authenticate using NTLM credentials
    enabling threat actors to steal NTLMv2 hashes for initial access.  
