name: Using a Windows command prompt for credential manipulation
criticality: Medium
references:
  public:
    1: https://learn.microsoft.com/en-us/windows-server/administration/windows-commands/cmdkey
    2: https://social.technet.microsoft.com/wiki/contents/articles/1410.windows-how-to-run-with-alternate-credentials-and-open-elevated-command-prompts.aspx
    3: https://stackoverflow.com/questions/28470945/retrieving-password-from-windows-credential-manager-using-cmd
    4: https://www.thewindowsclub.com/manage-credential-manager-using-command-prompt
    5: https://serverfault.com/questions/410240/is-there-a-windows-command-line-utility-to-verify-user-credentials
    6: https://www.technig.com/managing-user-account-using-command-line/
    7: https://superuser.com/questions/122764/ove-a-users-password-using-net-command
    8: https://www.mandiant.com/resources/blog/pick-six-intercepting-a-fin6-intrusion
    9: https://www.fbi.gov/contact-us/field-offices/seattle/news/stories/how-cyber-crime-group-fin7-attacked-and-stole-data-from-hundreds-of-us-companies
    10: https://securityaffairs.com/97957/apt/fox-kitten-campaign-vpn-bugs.html
    11: https://threatpost.com/ke3chang-apt-undocumented-backdoor/146537/
    12: https://www.wired.com/2017/05/close-look-notorious-apt32-hacking-group-action/
    13: https://www2.fireeye.com/rs/848-DID-242/images/rpt_APT37.pdf
    14: https://www.bleepingcomputer.com/news/security/russian-apt29-hackers-stealthy-malware-undetected-for-years/
  #internal:
    #a: 
  #restricted:
    #A: 
  #reports:
    #-

metadata:
  uuid: 06523ed4-7881-4466-9ac5-f8417e972d13
  schema: tvm::2.0
  tlp: clear
  version: 3
  created: 2023-01-26
  modified: 2023-01-26
  organisation:
    uuid: 56b0a0f0-b0bc-47d9-bb46-02f80ae2065a
    name: EC DIGIT CSOC

threat:
  actors:
    - name: att&ck::G0009 #[Enterprise] Deep Panda, Black Vine, KungFu Kittens, PinkPanther, Shell Crew, WebMasters
    - name: misp::066d25c1-71bd-4bd4-8ca7-edbba00063f4 #APT19, DEEP PANDA, Codoso, WebMasters, KungFu Kittens, Black Vine, TEMP.Avengers, Group 13, PinkPanther, Shell Crew, BRONZE FIRESTONE, G0009, G0073, Pupa, Sunshop Group
    - name: att&ck::G0050 #[Enterprise] APT32, APT-C-00, BISMUTH, Canvas Cyclone, OceanLotus, SeaLotus
    - name: misp::aa29ae56-e54b-47a2-ad16-d3ab0242d5d7 #APT32, OceanLotus Group, Ocean Lotus, OceanLotus, Cobalt Kitty, APT-C-00, SeaLotus, Sea Lotus, APT-32, APT 32, Ocean Buffalo, POND LOACH, TIN WOODLAWN, BISMUTH, ATK17, G0050, Canvas Cyclone
    - name: att&ck::G0087 #[Enterprise] APT39, Chafer, ITG07, Remix Kitten
    - name: misp::c2c64bd3-a325-446f-91a8-b4c0f173a30b #APT39, Chafer, REMIX KITTEN, COBALT HICKMAN, G0087, Radio Serpens, TA454, ITG07
    - name: att&ck::G0035 #[Enterprise] Dragonfly, BROMINE, Berserk Bear, Crouching Yeti, DYMALLOY, Energetic Bear, Ghost Blizzard, IRON LIBERTY, TEMP.Isotope, TG-4192
    - name: misp::64d6559c-6d5c-4585-bbf9-c17868f763ee #ENERGETIC BEAR, BERSERK BEAR, ALLANITE, CASTLE, DYMALLOY, TG-4192, Dragonfly, Crouching Yeti, Group 24, Havex, Koala Team, IRON LIBERTY, G0035, ATK6, ITG15, BROMINE, Blue Kraken, Ghost Blizzard
    - name: att&ck::G0037 #[Enterprise] FIN6, Camouflage Tempest, ITG08, Magecart Group 6, Skeleton Spider, TAAL
    - name: misp::647894f6-1723-4cba-aba4-0ef0966d5302 #FIN6, SKELETON SPIDER, ITG08, MageCart Group 6, White Giant, GOLD FRANKLIN, ATK88, G0037, Camouflage Tempest, TA4557
    - name: att&ck::G0046 #[Enterprise] FIN7, Carbon Spider, ELBRUS, GOLD NIAGARA, ITG14, Sangria Tempest
    - name: misp::00220228-a5a4-4032-a30d-826bb55aa3fb #FIN7, CARBON SPIDER, GOLD NIAGARA, Calcium, ATK32, G0046, G0008, Coreid, Carbanak, Sangria Tempest, ELBRUS, Carbon Spider, JokerStash
    - name: att&ck::G0117 #[Enterprise] Fox Kitten, Lemon Sandstorm, Parisite, Pioneer Kitten, RUBIDIUM, UNC757
    - name: misp::bfb0bc20-5bdf-47ff-b07f-dbd9a3cb9772 #Fox Kitten, PIONEER KITTEN, PARISITE, UNC757, Lemon Sandstorm, RUBIDIUM
    - name: att&ck::G0049 #[Enterprise] OilRig, APT34, COBALT GYPSY, EUROPIUM, Evasive Serpens, Hazel Sandstorm, Helix Kitten, IRN2, ITG13
    - name: misp::42be2a84-5a5c-4c6d-9864-3f09d75bb0ba #OilRig, Twisted Kitten, Cobalt Gypsy, Crambus, Helix Kitten, APT 34, APT34, IRN2, ATK40, G0049, Evasive Serpens, Hazel Sandstorm, EUROPIUM, TA452, Earth Simnavaz
    - name: att&ck::G0016 #[Enterprise] APT29, Blue Kitsune, Cozy Bear, CozyDuke, Dark Halo, IRON HEMLOCK, IRON RITUAL, Midnight Blizzard, NOBELIUM, NobleBaron, SolarStorm, The Dukes, UNC2452, UNC3524, YTTRIUM
    - name: misp::2ee5ed7a-c4d0-40be-a837-20817474a15b #UNC2452, DarkHalo, StellarParticle, NOBELIUM, Solar Phoenix, Midnight Blizzard
  killchain: Execution
  att&ck:
    - T1059.003
    - T1098.001
  domains:
    - Enterprise
    - Private Cloud
    - Public Cloud
  terrain: |
    Requires an already compromised Windows endpoint and in some cases elevated
    administrator privileges to command prompt interface. 
  targets:
    - API Endpoints
    - Control Server
    - Remote access
    - Desktop
    - Laptop
    - End-user
    - Workstations
    - Public-Facing Servers
    - Web Application Servers
  platforms:
    - Windows
  severity: Localised incident
  leverage:
    - Tampering
  impact:
    - Nuisance
  viability: Likely
  description: |
    Threat actors may use Windows commad prompt commands to search for, access
    in order to manipulate (create, modify, delete, read) user's credentials
    locally or in a domain. For example, they can extract user's passwords from
    Credential Manager. Windows Credential Manager is a store with all user's
    saved passwords automatically during user daily work. It provides an
    interface from where the credentials can be managed. To access Credential
    Manager, the threat actor needs to elevate his previleges to administrator
    and run the command promt console with "Run as administrator".

    Cmdkey.exe is a command-prompt utility which can create, list, and delete
    stored user names and passwords or credentials. It's usually located in the 
    %SYSTEM% sub-folder and its usual size is around 13,850 bytes.

    Example for try to gain user's details with cmdkey from Windows Credential
    Manager:

    cmdkey /list:testTarget

    The command returns the Target(testTarget), Type(Domain Password), and the
    Username(testUser).

    A threat actor can also manipulate the Credential Manager database, for
    example to add, modify or delete credentials from manager sections. It is
    possible to add an Internet or network address, user name, password and
    others.

    Example for adding of entry in Credential Manager. With the command below
    a threat actor can add username-password key pair for access to specific
    system.

    cmdkey /add:computer-name /user:user-name /pass:your-password

    Example for deletion of entry in Credential Manager. A threat actor fist
    execute list command to see all potential targets and select an entry for
    deletion.

    cmdkey /list
    cmdkey /delete:target-name

    Another approach to search and retrieve user's credentials with command
    promt is for example with net utility. Net utility executed via the network 
    is used to query for user's password. The passwords can be storred on shared
    network drives or locally.

    Example:

    net use \\unc\path /user:username password

    or 

    net use \\%userdnsdomain% /user:%userdomain%\%username% *

    The asterisk at the end forces to ask for password.

    With net utility a threat actor can also modify already existing user name
    or password or to delete the existing credentials entry. 

    Examples: 

    net user <username> *
    <type a new password>
    <retype the new password to confirm>

    The command below will set the password to blank:
    net user username "" 

    The following command will remove the password for the user with the
    specified userneme:

    net user <username> /passwordreq:no

