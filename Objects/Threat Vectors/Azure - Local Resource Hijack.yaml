name: Azure - Local Resource Hijack
criticality: High
references:
  public:
    1: https://orca.security/resources/blog/azure-machine-learning-privilege-escalation/
    2: https://microsoft.github.io/Azure-Threat-Research-Matrix/PrivilegeEscalation/AZT403/AZT403-1/
    3: https://www.netspi.com/blog/technical-blog/cloud-penetration-testing/attacking-azure-cloud-shell/
  #internal:
    #a: 

metadata:
  uuid: 85c8e0dd-b012-402d-bb09-5d354c16ebb9
  schema: tvm::2.1
  version: 2
  created: 2025-08-26
  modified: 2025-09-04
  tlp: clear
  #author: 
  #contributors:
    #-
  organisation:
    uuid: 56b0a0f0-b0bc-47d9-bb46-02f80ae2065a
    name: EC DIGIT CSOC

threat:
  actors:
    - name: misp::b2056ff0-00b9-482e-b11c-c771daa5f28a #APT29, Group 100, COZY BEAR, The Dukes, Minidionis, SeaDuke, YTTRIUM, IRON HEMLOCK, Grizzly Steppe, G0016, ATK7, Cloaked Ursa, TA421, Blue Kitsune, ITG11, BlueBravo, Nobelium, UAC-0029
      sighting: |
        Russian APT29 hackers abuse Azure services to hack Microsoft 365 users
      references:
        - https://www.bleepingcomputer.com/news/security/russian-apt29-hackers-abuse-azure-services-to-hack-microsoft-365-users/
        - https://blog.cyberonix.net/security/2025/04/operation-cloudpiercer-apt29-exploits-azure-misconfigurations-in-global-supply-chain-attack/
   
  killchain: Privilege Escalation
  att&ck:
    - T1496 #Resource Hijacking
    - T1098.001 #Account Manipulation: Additional Cloud Credentials
    - T1078.004 #Valid Accounts: Cloud Accounts
  chaining:
    - relation: sequence::preceeds
      vector: b1593e0b-1b3b-462d-9ab6-21d1c136469d #Azure - Gather Resource Data
      description: |
        The attacker obtains credentials (via phishing, password spray, leaked keys)
        granting at least Reader access to the target Azure tenant.
  #cve:
    #-
  #misp:
    #-
  domains:
    - Public Cloud
  terrain: |
    Adversaries obtain write permissions on a target storage account (e.g., AML storage, 
    CloudShell profile storage) through misconfiguration, compromised credentials, or 
    access inheritance.
  targets:
    - Cloud Storage Accounts
    - Cloud Portal
    - Identity Services
    - Virtual Machines
    - IaaS
  platforms:
    - Azure
    - Azure AD
  severity: Significant incident
  leverage:
    - Tampering
    - Elevation of privilege
    - Information Disclosure
  impact:
    - Data Breach
    - IP Loss
  viability: Likely
  description: |
    The following threat vector involves attackers tampering with local files or resources—such 
    as profile scripts or pipeline artifacts—to escalate privileges and gain unauthorized 
    access to cloud resources.

    ## Example Attack Scenario

    An adversary, with write access to a storage account linked to Azure Machine Learning 
    (AML) or Azure CloudShell, modifies a startup or invoker script (e.g., `.bashrc` 
    or pipeline component scripts) stored in blob storage. For AML, the attacker replaces 
    a component invoker script with malicious code that executes during the next scheduled 
    pipeline job. The code then exploits the AML compute’s managed identity—potentially 
    inheriting elevated permissions from the pipeline owner—to extract secrets from 
    Azure Key Vault, reassign roles, or access broader Azure resources. In CloudShell, 
    the `.bashrc` file inside the `.IMG` profile is altered to run commands that covertly 
    add an attacker account to privileged roles across the subscription.

    ## Attack Goals and Impact

    - **Privilege escalation**: The attacker aims to execute code or commands under 
    a more privileged identity, going from low user/storage access to Contributor, Owner, 
    or admin roles in Azure. This may involve extracting secrets from Key Vaults, accessing 
    sensitive data, or reassigning role memberships.
    - **Persistence and lateral movement**: By hijacking profile/startup scripts or 
    pipeline artifacts, the attacker ensures continued access, potentially moving laterally 
    to other cloud services or even on-premises networks—all without triggering immediate alarms.
    - **Resource abuse**: Attackers may run unauthorized workloads, such as cryptominers, 
    or deploy malware, impacting resource costs and security posture.

    ## Attack Flow and Methodology

    1. **Script modification**:
      - AML case: The attacker modifies or uploads a malicious invoker script to the 
      pipeline component directory in the Storage Account. If necessary, the YAML config 
      is altered to ensure execution of the script.
      - CloudShell case: The attacker alters the `.bashrc` (or PowerShell profile) 
      file inside the profile `.IMG` so that, on shell launch, privileged escalation 
      or backdoor commands are executed.
    2. **Execution and privilege escalation**:
      - On the next job/pipeline run (AML) or CloudShell launch, the modified script 
      executes with the context of the managed/system identity—often inheriting the 
      permissions of the pipeline owner or compute administrator.
      - Malicious code retrieves secrets, changes role assignments, or accesses broader 
      Azure resources; for CloudShell, commands may add attacker accounts to privileged 
      Azure roles automatically.
    3. **Persistence and impact**:
      - The attacker may persist access by continuously modifying invocation scripts 
      or startup files, or by creating new high-privilege accounts/role assignments.
      - Broader impact includes data exfiltration, resource hijacking, or stealthy 
      malware deployment.
