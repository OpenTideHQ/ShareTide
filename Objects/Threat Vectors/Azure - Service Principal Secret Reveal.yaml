name: Azure - Service Principal Secret Reveal
criticality: High
references:
  public:
    1: https://microsoft.github.io/Azure-Threat-Research-Matrix/CredentialAccess/CredentialAccess/
    2: https://microsoft.github.io/Azure-Threat-Research-Matrix/CredentialAccess/AZT603/AZT603-1/
    3: https://misp-galaxy.org/atrm/
  #internal:
    #a: 

metadata:
  uuid: c4edae81-5790-4b9c-88b7-d11d6985b1a4
  schema: tvm::2.1
  version: 1
  created: 2025-09-18
  modified: 2025-09-19
  tlp: clear
  #author: 
  #contributors:
    #-
  organisation:
    uuid: 56b0a0f0-b0bc-47d9-bb46-02f80ae2065a
    name: EC DIGIT CSOC

threat:
  #actors:
    #- name: 
      #sighting: |
        #...
      #references:
        #-
  killchain: Credential Access
  att&ck:
    - T1098.001 #Account Manipulation: Additional Cloud Credentials
    - T1078.004 #Valid Accounts: Cloud Accounts
    - T1526 #Cloud Service Discovery
  chaining:
    - relation: support::enabled
      vector: 53063205-4404-4e6d-a2f5-d566c6085d96 #Data collection using SharpHound, SoapHound, Bloodhound & Azurehound
      description: |
        Attackers need to establish an initial presence within the target environment, in 
        order to gather sufficient permissions to execute the data collection tools.
    - relation: support::enabling
      vector: 5d43ef75-4637-4a75-b1ed-6716052cff0e #Azure - App registration persistence
      description: |
        Adversaries need access to an identity (user account or service principal) with 
        sufficient permissions to create, modify, or assign roles to app registrations or 
        service principals.
    - relation: support::enabled
      vector: 4e7eae8e-6615-41f2-bfe1-21a04f7a6088 #Azure - Gather Victim Data
      description: |
        An adversary successfully compromises a user's Azure Active Directory account credentials 
        or session token through phishing, credential theft, or token theft.
    - relation: support::enabled
      vector: fe6827f2-efb4-43b3-9ca3-b7d417111b32 #Azure - Gather Application Information
      description: |
        Adversaries obtain minimal access (often as a standard user or via an external account) 
        in the target Azure AD tenant, then utilizes API endpoints and tools, such as Azure CLI, 
        PowerShell modules (e.g., MSOnline, Microsoft.Graph), or custom scripts, to list 
        all registered applications.
    - relation: support::enabled
      vector: bb2501d5-99c7-44a6-ac5a-9510102d6611 #Azure - Principal Impersonation
      description: |
        Adversaries gains access via phishing, credential stuffing, or exploiting misconfigurations 
        allowing access to an account with application management permissions or to a pipeline 
        that exposes service principal credentials.
    - relation: support::enabling
      vector: c7e260d8-d391-41eb-be1a-7f276c99b383 #Azure app registration - privilege escalation
      description: |
        Adversaries need access to an identity (user account or service principal) with 
        sufficient permissions to create, modify, or assign roles to app registrations or 
        service principals.
    - relation: atomicity::implemented
      vector: 2743bf18-3b86-4721-bf3e-153dcda0b149 #Azure - Valid Credentials
      description: |
        Adversaries obtain the username and password of an AzureAD user either through phishing, 
        password spraying, brute-force attacks, or credentials leaked online.    
  #cve:
    #-
  #misp:
    #-
  domains:
    - Public Cloud
  terrain: |
    Adversaries must gain access to the Azure environment or function app through phishing, 
    compromised credentials, misconfigurations, or vulnerability exploitation.
  targets:
    - Cloud Storage Accounts
    - Identity Services
    - API Endpoints
    - Serverless
  platforms:
    - Azure
    - Azure AD
  severity: Significant incident
  leverage:
    - Spoofing
    - Tampering
    - Elevation of privilege
    - Information Disclosure 
  impact:
    - Data Breach
    - IP Loss
    - Reputational Damages
    - Identity Theft
  viability: Likely
  description: |
    The following threat vector involves an adversary revealing a service principal's 
    secret (a credential) in plain text, which can then be used for unauthorized access 
    and further attacks.

    ### Example Attack Scenario

    An adversary targets an Azure Function App that uses a service principal for authentication. 
    The attacker exploits the Function App by manipulating its application logic to 
    reveal the service principal's secret in plain text. This secret, which acts like 
    a password, provides direct authentication access as the service principal identity, 
    enabling the attacker to escalate privileges or move laterally within the Azure environment.

    ### Attack Goals and Impact

    The primary goal of the "Service Principal Secret Reveal" attack is to gain unauthorized 
    access to service principal credentials. With these credentials, the attacker can:

    - Authenticate as the service principal identity.
    - Access resources and perform actions permitted to the service principal.
    - Potentially escalate privileges by abusing the service principal's permission scope.
    - Maintain persistence in the environment by leveraging the stolen secret.
    - Move laterally across Azure resources to further compromise the target environment.

    ### Attack Flow and Methodology

    1. **Identify Target Service Principal**: The attacker discovers that the Function 
    App uses a service principal for authentication.
    2. **Manipulate Function App Logic**: The attacker modifies the Function App's code 
    or configuration to extract and reveal the service principal's secret in plain text.
    3. **Secret Disclosure**: The service principal secret is exposed and accessible 
    to the attacker.
    4. **Credential Use**: The attacker uses the secret to authenticate as the service 
    principal identity.
    5. **Privilege Escalation and Lateral Movement**: Using the service principal's 
    permissions, the attacker can escalate privileges and move laterally across Azure resources.
    6. **Persistence and Further Exploitation**: The attacker may maintain persistent 
    access, harvest additional credentials, or exfiltrate sensitive data.
